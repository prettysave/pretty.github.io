<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <title>mysql-overview | 嗯哼</title>
  <meta name="keywords" content=" mysql ">
  <meta name="description" content="mysql-overview | 嗯哼">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="## 页面未找到！">
<meta property="og:type" content="website">
<meta property="og:title" content="404">
<meta property="og:url" content="http://yoursite.com/404.html">
<meta property="og:site_name" content="嗯哼">
<meta property="og:description" content="## 页面未找到！">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-09-25T04:48:17.169Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="404">
<meta name="twitter:description" content="## 页面未找到！">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1.1.0" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.1.0" rel="stylesheet">

<link href="//cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" rel="stylesheet">

<script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="/js/titleTip.js?v=1.1.0"></script>

<script src="//cdn.jsdelivr.net/npm/highlightjs@9.16.2/highlight.pack.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js"></script>



<script src="//cdn.jsdelivr.net/npm/jquery.cookie@1.4.1/jquery.cookie.min.js"></script>

<script src="/js/iconfont.js?v=1.1.0"></script>

</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value>
  <input class="theme_blog_path" value>
  <input id="theme_shortcut" value="true">
  <input id="theme_highlight_on" value="true">
  <input id="theme_code_copy" value="true">
</div>



<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>嗯哼</span>
</div>

<div class="icon">
    
        
    
        
        <a title="github" href="https://github.com/prettysave" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"></use>
                </svg>
            
        </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
        <a title="email" href="mailto:prettysave@163.com" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-email"></use>
                </svg>
            
        </a>
        
    
        
        <a title="qq" href="http://wpa.qq.com/msgrd?v=3&uin=1642838275&site=qq&menu=yes" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-qq"></use>
                </svg>
            
        </a>
        
    
        
    
        
    
</div>




<ul>
    <li><div class="all active" data-rel="全部文章">全部文章<small>(11)</small></div></li>
    
        
            
            <li><div data-rel="JAVA">JAVA<small>(6)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="数据库">数据库<small>(2)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="设计模式">设计模式<small>(3)</small></div>
                
            </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div><a class="about  hasFriend  site_url"  href="/about">关于</a><a style="width: 50%"  class="friends">友链</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="11">
<input type="hidden" id="yelog_site_word_count" value="25.5k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="iconfont icon-left"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="http://yelog.org/">叶落阁</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <div class="right-top">
        <div id="default-panel">
            <i class="iconfont icon-search" data-title="搜索 快捷键 i"></i>
            <div class="right-title">全部文章</div>
            <i class="iconfont icon-file-tree" data-title="切换到大纲视图 快捷键 w"></i>
        </div>
        <div id="search-panel">
            <i class="iconfont icon-left" data-title="返回"></i>
            <input id="local-search-input" />
            <label class="border-line" for="input"></label>
            <i class="iconfont icon-case-sensitive" data-title="大小写敏感"></i>
            <i class="iconfont icon-tag" data-title="标签"></i>
        </div>
        <div id="outline-panel" style="display: none">
            <div class="right-title">大纲</div>
            <i class="iconfont icon-list" data-title="切换到文章列表"></i>
        </div>
    </div>

    <div class="tags-list">
    <input id="tag-search" />
    <div class="tag-wrapper">
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>JVM</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>mysql</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>优化</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>创建型模式</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>结构型模式</a>
            </li>
        
            <li class="article-tag-list-item">
                <i class="iconfont icon-tag"></i><a>行为型型模式</a>
            </li>
        
    </div>

</div>

    
    <nav id="title-list-nav">
        
        <a  class="全部文章 数据库 "
           href="/2020/09/28/mysql-overview/"
           data-tag="mysql"
           data-author="" >
            <span class="post-title" title="mysql-overview">mysql-overview</span>
            <span class="post-date" title="2020-09-28 18:41:37">2020/09/28</span>
        </a>
        
        <a  class="全部文章 数据库 "
           href="/2020/09/23/mysql-bulk-data-loading/"
           data-tag="mysql,优化"
           data-author="" >
            <span class="post-title" title="mysql中大量数据插入的优化（innodb篇）">mysql中大量数据插入的优化（innodb篇）</span>
            <span class="post-date" title="2020-09-23 10:48:03">2020/09/23</span>
        </a>
        
        <a  class="全部文章 JAVA "
           href="/2020/09/19/JVM_load/"
           data-tag="JVM"
           data-author="" >
            <span class="post-title" title="JVM - 类加载">JVM - 类加载</span>
            <span class="post-date" title="2020-09-19 15:57:32">2020/09/19</span>
        </a>
        
        <a  class="全部文章 JAVA "
           href="/2020/09/12/JVM_optimize/"
           data-tag="JVM"
           data-author="" >
            <span class="post-title" title="JVM - JVM性能调优">JVM - JVM性能调优</span>
            <span class="post-date" title="2020-09-12 10:25:11">2020/09/12</span>
        </a>
        
        <a  class="全部文章 JAVA "
           href="/2020/09/05/JVM_overflow/"
           data-tag="JVM"
           data-author="" >
            <span class="post-title" title="JVM - JVM内存溢出">JVM - JVM内存溢出</span>
            <span class="post-date" title="2020-09-05 16:33:45">2020/09/05</span>
        </a>
        
        <a  class="全部文章 JAVA "
           href="/2020/08/29/JVM_G1/"
           data-tag="JVM"
           data-author="" >
            <span class="post-title" title="JVM - 垃圾回收算法-G1">JVM - 垃圾回收算法-G1</span>
            <span class="post-date" title="2020-08-29 14:03:24">2020/08/29</span>
        </a>
        
        <a  class="全部文章 JAVA "
           href="/2020/08/22/JVM_collect/"
           data-tag="JVM"
           data-author="" >
            <span class="post-title" title="JVM - 垃圾回收算法">JVM - 垃圾回收算法</span>
            <span class="post-date" title="2020-08-22 17:03:24">2020/08/22</span>
        </a>
        
        <a  class="全部文章 JAVA "
           href="/2020/08/15/JVM_area/"
           data-tag="JVM"
           data-author="" >
            <span class="post-title" title="JVM - JVM内存区域">JVM - JVM内存区域</span>
            <span class="post-date" title="2020-08-15 13:47:19">2020/08/15</span>
        </a>
        
        <a  class="全部文章 设计模式 "
           href="/2019/11/11/dm3/"
           data-tag="行为型型模式"
           data-author="" >
            <span class="post-title" title="设计模式（3）- 行为型模式">设计模式（3）- 行为型模式</span>
            <span class="post-date" title="2019-11-11 15:27:11">2019/11/11</span>
        </a>
        
        <a  class="全部文章 设计模式 "
           href="/2019/11/05/dm2/"
           data-tag="结构型模式"
           data-author="" >
            <span class="post-title" title="设计模式（2）- 结构型模式">设计模式（2）- 结构型模式</span>
            <span class="post-date" title="2019-11-05 11:27:58">2019/11/05</span>
        </a>
        
        <a  class="全部文章 设计模式 "
           href="/2019/10/26/dm1/"
           data-tag="创建型模式"
           data-author="" >
            <span class="post-title" title="设计模式（1）- 创建型模式">设计模式（1）- 创建型模式</span>
            <span class="post-date" title="2019-10-26 13:28:56">2019/10/26</span>
        </a>
        
        <div id="no-item-tips">

        </div>
    </nav>
    <div id="outline-list">
    </div>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle" data-title="切换全屏 快捷键 s">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div id="post">
    <div class="pjax">
        <article id="post-mysql-overview" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">mysql-overview</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            <i class="iconfont icon-category"></i>
            
            
            <a  data-rel="数据库">数据库</a>
            
        </span>
        
        
        <span class="tag">
            <i class="iconfont icon-tag"></i>
            
            <a class="color1">mysql</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
            发布时间 : <time class="date" title='最后更新: 2020-09-28 19:00:36'>2020-09-28 18:41</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:2.9k</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读 :<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
        <span class="top-comment" title="跳转至评论区">
            <a href="#comments">
                评论:<span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </a>
        </span>
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#架构"><span class="toc-text">架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#连接层（服务层）"><span class="toc-text">连接层（服务层）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务层（核心服务层）："><span class="toc-text">服务层（核心服务层）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#存储引擎层"><span class="toc-text">存储引擎层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#存储层"><span class="toc-text">存储层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sql语句执行流程"><span class="toc-text">sql语句执行流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#存储引擎"><span class="toc-text">存储引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#InnoDB"><span class="toc-text">InnoDB</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MyISAM"><span class="toc-text">MyISAM</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据类型"><span class="toc-text">数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#整数类型"><span class="toc-text">整数类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#浮点数类型"><span class="toc-text">浮点数类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#字符串类型"><span class="toc-text">字符串类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日期类型"><span class="toc-text">日期类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#其他类型"><span class="toc-text">其他类型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引"><span class="toc-text">索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#需要创建索引"><span class="toc-text">需要创建索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#不要创建索引"><span class="toc-text">不要创建索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#innodb"><span class="toc-text">innodb</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事务"><span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ACID-事务基本要素"><span class="toc-text">ACID-事务基本要素</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#并发事务处理的问题"><span class="toc-text">并发事务处理的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#事务隔离级别"><span class="toc-text">事务隔离级别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MVCC多版本并发控制-innodb"><span class="toc-text">MVCC多版本并发控制(innodb)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实现"><span class="toc-text">实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#事务日志"><span class="toc-text">事务日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#redo-log"><span class="toc-text">redo log</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#undo-log"><span class="toc-text">undo log</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其他日志"><span class="toc-text">其他日志</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#锁"><span class="toc-text">锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#innodb的意向锁（IS、IX）"><span class="toc-text">innodb的意向锁（IS、IX）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#记录锁"><span class="toc-text">记录锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自增锁"><span class="toc-text">自增锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#间隙锁"><span class="toc-text">间隙锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#死锁"><span class="toc-text">死锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#innodb避免死锁"><span class="toc-text">innodb避免死锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#myisam避免死锁"><span class="toc-text">myisam避免死锁</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#调优"><span class="toc-text">调优</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#索引优化"><span class="toc-text">索引优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一般性建议"><span class="toc-text">一般性建议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询优化"><span class="toc-text">查询优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分区、分表、分库（todo）"><span class="toc-text">分区、分表、分库（todo）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#主从复制-todo"><span class="toc-text">主从复制(todo)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其它"><span class="toc-text">其它</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#百万级别或以上的数据如何删除"><span class="toc-text">百万级别或以上的数据如何删除</span></a></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><h3 id="连接层（服务层）"><a href="#连接层（服务层）" class="headerlink" title="连接层（服务层）"></a>连接层（服务层）</h3><p>​        JDBC、ODBC等;<br>​        连接处理、授权认证等;</p>
<h3 id="服务层（核心服务层）："><a href="#服务层（核心服务层）：" class="headerlink" title="服务层（核心服务层）："></a>服务层（核心服务层）：</h3><p>​        触发器、存储过程、视图等跨存储引擎的功能<br>​        查询缓存：如果命中缓存 则直接返回结果<br>​        分析器：词法分析、语法分析<br>​        优化器：执行计划生成、索引选择<br>​        执行器：操作引擎，返回结果</p>
<h3 id="存储引擎层"><a href="#存储引擎层" class="headerlink" title="存储引擎层"></a>存储引擎层</h3><p>​        负责数据的存储和提取<br>​        通过API与存储引擎通信</p>
<h3 id="存储层"><a href="#存储层" class="headerlink" title="存储层"></a>存储层</h3><p>​        将数据存储于设备的文件系统中，持久化<br>​        完成与存储引擎的交互</p>
<h3 id="sql语句执行流程"><a href="#sql语句执行流程" class="headerlink" title="sql语句执行流程"></a>sql语句执行流程</h3><p>​        客户端请求→连接器（验证用户身份。给予权限）→<br>​        查询缓存（存在直接返回，不存在继续后续操作）→<br>​        分析器（对SQL进行词法、语法分析）→<br>​        优化器（主要对执行的SQL选择最优的执行方案）→<br>​        执行器（先验证是否有执行权限，有权限才使用引擎提供的接口）→<br>​        引擎层获取数据返回（如果开启查询缓存则会缓存查询结果）</p>
<h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><h3 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h3><p>​        支持事务<br>​        支持外键<br>​        最小粒度是行锁<br>​        自增主键的最大ID记录在内存中</p>
<h3 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h3><p>​        不支持事务<br>​        不支持外键<br>​        最小粒度是表锁<br>​        自增主键的最大ID记录在数据文件中 </p>
<h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><h3 id="整数类型"><a href="#整数类型" class="headerlink" title="整数类型"></a>整数类型</h3><p>​        bit<br>​        bool<br>​        tiny int<br>​        small int<br>​        medium int<br>​        int<br>​        big int</p>
<h3 id="浮点数类型"><a href="#浮点数类型" class="headerlink" title="浮点数类型"></a>浮点数类型</h3><p>​        float<br>​        double<br>​        decimal</p>
<h3 id="字符串类型"><a href="#字符串类型" class="headerlink" title="字符串类型"></a>字符串类型</h3><p>​        char：固定长度，char(n)中n代表字符个数，并不代表字节个数,存储上限255,适合短、固定长度的字符串，对于非常短的列，char在存储空间上更有效率<br>​        varchar：可变长度，n代表字符个数，存储上限65535字节（行的长度上限）,需要额外的1或2个字节记录长度<br>​        tiny text<br>​        text：保存字符数据<br>​        medium text<br>​        longtext<br>​        tiny blob<br>​        blob：保存二进制数据<br>​        medium blob<br>​        long blob</p>
<h3 id="日期类型"><a href="#日期类型" class="headerlink" title="日期类型"></a>日期类型</h3><p>​        date<br>​        date time<br>​        timestamp<br>​        time<br>​        year</p>
<h4 id="其他类型"><a href="#其他类型" class="headerlink" title="其他类型"></a>其他类型</h4><p>​        binary<br>​        var binary<br>​        enum<br>​        set<br>​        geometry<br>​        point<br>​        multipoint<br>​        …</p>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><h3 id="需要创建索引"><a href="#需要创建索引" class="headerlink" title="需要创建索引"></a>需要创建索引</h3><p>​        主键字段建立唯一索引<br>​        频繁作为查询条件的字段<br>​        查询中与其他表关联的字段，外键关系建立索引<br>​        查询中排序的字段<br>​        查询中统计或分组字段</p>
<h3 id="不要创建索引"><a href="#不要创建索引" class="headerlink" title="不要创建索引"></a>不要创建索引</h3><p>​        表记录太少<br>​        经常增删改的表<br>​        数据重复且分布均匀的表字段（区分度不高，意义不大）<br>​        where条件用不到的字段</p>
<h3 id="innodb"><a href="#innodb" class="headerlink" title="innodb"></a>innodb</h3><p>​        page默认大小16KB，一般表的主键类型为INT（占用4个字节）或BIGINT（占用8个字节），指针类型也一般为4或8个字节，也就是说一个页（B+Tree中的一个节点）中大概存储16KB/(8B+8B)=1K个键值（因为是估值，为方便计算，这里的K取值为10^3）。也就是说一个深度为3的B+Tree索引可以维护10^3 * 10^3 * 10^3 = 10亿 条记录。</p>
<h2 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h2><h3 id="ACID-事务基本要素"><a href="#ACID-事务基本要素" class="headerlink" title="ACID-事务基本要素"></a>ACID-事务基本要素</h3><p>​        A（atomicity）原子性:一个事务中的所有操作，要么全部完成，要么全部不完成<br>​        C（consistency）一致性:在事务开始之前和事务结束之后，数据库的完整性约束没有被破坏。<br>​        I(isolation)隔离性：一个事务的执行不能影响到其它事务的执行，并发执行的各个事务之间不能互相干扰。<br>​        D（durability）持久性：事务完成以后，该事务对数据库所做的更改便持久的保存在数据库中。</p>
<h3 id="并发事务处理的问题"><a href="#并发事务处理的问题" class="headerlink" title="并发事务处理的问题"></a>并发事务处理的问题</h3><p>​        更新丢失：事务A和事务B选择同一行，然后基于最初选定的值更新该行时，由于两个事务都不知道彼此的存在，就会发生丢失更新问题<br>​        脏读：事务A读取了事务B未提交的数据，然后事务B回滚,A读到的数据就是脏数据,<br>​        不可重复读：事务A多次读取同一数据，事务B在事务A多次读取的过程中，对数据做了更改并提交，导致事务A多次读取同一数据时，结果不一致。<br>​        幻读：类似于不可重复读，不可重复读指的是同一数据多次读取不一致，幻读是指在一个范围内，多次读取的数据条数不一致.</p>
<h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h3><p>​        读未提交（read uncommitted）：最低的隔离级别，可能导致脏读、幻读、不可重复读<br>​        读已提交（read committed）：允许读取并发事务已经提交的数据，可以阻止脏读，可能发送幻读、不可重复读<br>​        可重复读（repeatable read）–默认事务隔离级别：可以阻止脏读和不可重复读，但幻读仍有可能发生。(innodb中通过mvcc避免的幻读)<br>​        可串行（serializable）：最高的隔离级别，所有事务依次逐个执行，虽然可以防止所有问题。但是基本上不用</p>
<h3 id="MVCC多版本并发控制-innodb"><a href="#MVCC多版本并发控制-innodb" class="headerlink" title="MVCC多版本并发控制(innodb)"></a>MVCC多版本并发控制(innodb)</h3><p>​        committed read | repeatable read两种隔离级别下工作</p>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>​    聚簇索引列中额外记录了两个必要的隐藏列：<br>​        trx_id：记录改动后最新的事务ID<br>​        roll_pointer:相当于指针，可以通过它在undo日志中找到上一个版本的数据<br>read view:包含当前系统中的活跃的读写事务的id列表,命名为m_ids<br>​            如果被访问版本的trx_id小于m_ids中的最小值，说明生成该版本的事务在生成read view的时候已经提交，改版本可访问<br>​            如果trx_id大于m_ids中的最大值，表明生成该版本的事务在生成read view后才生成，不可访问<br>​            如果trx_id在mids的最大值和最小值之间，则判断是否在mids列表中，存在说明创建read view的时候该版本的trx_id的还未提交，不可访问；如果不在，可访问。<br>​            read committed – 每次读取数据都生成一个read view<br>​            repeatable read – 只在第一次读取数据时生成一个read view<br>​        在Innodb的mvcc实现下，repeatable read的实现是可以解决幻读问题的。</p>
<h3 id="事务日志"><a href="#事务日志" class="headerlink" title="事务日志"></a>事务日志</h3><h4 id="redo-log"><a href="#redo-log" class="headerlink" title="redo log"></a>redo log</h4><p>​            实现持久性和原子性<br>​            事务中的操作，会都先写入存储引擎中的日志缓存中，事务提交前，日志需要提前刷到磁盘持久化。<br>​            系统启动时为redo log分配了一块连续的存储空间，写入log时是顺序IO，所有的事务共享redo log的存储空间.<br>​            通过redo log 把数据的改动由随机IO转变为顺序IO–日志持久化相当于事务持久化了<br>​            innodb后台有一个线程智能的刷新log中的变更，可以批量写入，使的数据写入更顺序，以提高效率。<br>​            本质上是更新数据从一次随机IO变更成两个顺序IO–第一次写日志，第二次写数据文件</p>
<h4 id="undo-log"><a href="#undo-log" class="headerlink" title="undo log"></a>undo log</h4><p>​            实现一致性<br>​            主要为事务的回滚服务，记录了数据在每个操作前的状态.</p>
<h4 id="其他日志"><a href="#其他日志" class="headerlink" title="其他日志"></a>其他日志</h4><p>​            错误日志：记录出错信息，也记录一些警告信息或者正确的信息。<br>​            查询日志：记录所有对数据库请求的信息，不论这些请求是否得到了正确的执行。<br>​            慢查询日志：设置一个阙值，将运行时间超过该值的所有sql语句都记录到 慢查询日志文件中，<br>​            二进制日志：记录对数据库执行更改的所有操作。<br>​            中继日志：二进制日志，用来给slave库恢复。</p>
<h2 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h2><p>​    读锁<br>​    写锁<br>​    表级锁:开销小，加锁快，粒度大，并发度低<br>​    行级锁：开销大，加锁快，粒度小，并发度高</p>
<h3 id="innodb的意向锁（IS、IX）"><a href="#innodb的意向锁（IS、IX）" class="headerlink" title="innodb的意向锁（IS、IX）"></a>innodb的意向锁（IS、IX）</h3><p>​        表级锁，不会和行级的读写锁冲突，只会和表级的读写锁冲突。<br>​                  S          X<br>​        IS      兼容      互斥<br>​        IX      互斥      互斥<br>​        当向一个表添加表级锁时，如果没有意向锁，则需要遍历整个表判断是否有行锁的存在，以免发生冲突；有了意向锁，只需要判断意向锁与要添加的标所是否兼容即可。而无需遍历整个表。</p>
<h3 id="记录锁"><a href="#记录锁" class="headerlink" title="记录锁"></a>记录锁</h3><p>​        锁的是索引记录,如果没有索引，innodb会创建隐式的索引,并锁这个隐式索引。行锁就是记录锁。<br>​        如果索引失效会导致行锁变表锁，比如字符串类型查询不加引号的情况,</p>
<h3 id="自增锁"><a href="#自增锁" class="headerlink" title="自增锁"></a>自增锁</h3><p>​        特殊的表级锁，事务插入自增列的时候需要获取，当一个事务插入的时候，其他的事务都需要等待，这样第一个事务才能获得连续的自增值。</p>
<h3 id="间隙锁"><a href="#间隙锁" class="headerlink" title="间隙锁"></a>间隙锁</h3><p>​        索引记录之间的锁,只阻止其他事务插入间隙，不阻止其他事务获得间隙锁。可以解决幻读的问题。(r_c隔离级别下间隙锁是关闭的)</p>
<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><h4 id="innodb避免死锁"><a href="#innodb避免死锁" class="headerlink" title="innodb避免死锁"></a>innodb避免死锁</h4><ul>
<li>为了在单个innodb表上执行多个并发写入操作时避免死锁，可以在事务开始时使用select … for update 获取必要的锁，其实这些行的改动是在之后执行的。</li>
<li>先获取共享锁，再获取排他锁的情况下，有可能其他的事务也已经获得了相同记录的共享锁，从而造成锁冲突，甚至死锁<h4 id="myisam避免死锁"><a href="#myisam避免死锁" class="headerlink" title="myisam避免死锁"></a>myisam避免死锁</h4></li>
<li>在自动加锁的情况下，myisam总是一次获得sql语句所需要的全部锁。<h2 id="调优"><a href="#调优" class="headerlink" title="调优"></a>调优</h2><h3 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h3></li>
<li>最左前缀原则</li>
<li>不在索引列上做如何操作（计算、函数、(自动or手动)类型转换），会导致索引失效而转向全表扫描</li>
<li>is null ,is not null 也无法使用索引</li>
<li>字符串不加单引号索引失效</li>
<li>少用or，用它来连接时会索引失效</li>
<li>&lt;，&lt;=，=，&gt;，&gt;=，BETWEEN，IN 可用到索引，&lt;&gt;，not in ，!= 则不行，会导致全表扫描<h3 id="一般性建议"><a href="#一般性建议" class="headerlink" title="一般性建议"></a>一般性建议</h3><ul>
<li>对于单键索引，尽量选择针对当前query过滤性更好的索引</li>
<li>在选择组合索引的时候，当前Query中过滤性最好的字段在索引字段顺序中，位置越靠前越好。</li>
<li>在选择组合索引的时候，尽量选择可以能够包含当前query中的where字句中更多字段的索引</li>
<li>尽可能通过分析统计信息和调整query的写法来达到选择合适索引的目的</li>
<li>少用Hint强制索引<h3 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h3></li>
<li>永远小标驱动大表（小的数据集驱动大的数据集）</li>
<li>order by子句，尽量使用 Index 方式排序，避免使用 FileSort 方式排序</li>
<li>group by实质是先排序后进行分组，遵照索引建的最佳左前缀；where高于having，能写在where限定的条件就不要去having限定了<h3 id="分区、分表、分库（todo）"><a href="#分区、分表、分库（todo）" class="headerlink" title="分区、分表、分库（todo）"></a>分区、分表、分库（todo）</h3><h3 id="主从复制-todo"><a href="#主从复制-todo" class="headerlink" title="主从复制(todo)"></a>主从复制(todo)</h3><h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><h3 id="百万级别或以上的数据如何删除"><a href="#百万级别或以上的数据如何删除" class="headerlink" title="百万级别或以上的数据如何删除"></a>百万级别或以上的数据如何删除</h3></li>
</ul>
</li>
</ul>
<p>1.先删除索引（此时大概耗时三分多钟）<br>2.然后删除其中无用数据（此过程需要不到两分钟）<br>3.删除完成后重新创建索引(此时数据较少了)创建索引也非常快，约十分钟左右。<br>4.与之前的直接删除绝对是要快速很多，更别说万一删除中断,一切删除会回滚。那更是坑了。</p>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 prettysave@163.com </span>
    </div>
</article>


<p>
    <a  class="dashang" onclick="dashangToggle()">赏</a>
</p>




    <div id="comments"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

<script type="text/javascript">
    $.getScript('/js/gitalk.js', function () {
        var gitalk = new Gitalk({
            clientID: 'a9aa667d041fa8a0ac09',
            clientSecret: '552d88be4b5d7e4134a05590604c39697e638906',
            repo: 'prettysave.github.io',
            owner: 'prettysave',
            admin: ['prettysave'],
            id: decodeURI(location.pathname),
            distractionFreeMode: 'true',
            language: 'zh-CN',
            perPage: parseInt('10',10)
        })
        gitalk.render('comments')
    })
</script>




    




    </div>
    <div class="copyright">
        <p class="footer-entry">
    ©2019-2020 prettysave
</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full" data-title="切换全屏 快捷键 s"><span class="min "></span></button>
<a class="" id="rocket" ></a>

    </div>
</div>

<div class="hide_box" onclick="dashangToggle()"></div>
<div class="shang_box">
    <a class="shang_close"  onclick="dashangToggle()">×</a>
    <div class="shang_tit">
        <p>喜欢就点赞,疼爱就打赏</p>
    </div>
    <div class="shang_payimg">
        <div class="pay_img">
            <img src="/img/alipay.jpg" class="alipay" title="扫码支持">
            <img src="/img/weixin.jpg" class="weixin" title="扫码支持">
        </div>
    </div>
    <div class="shang_payselect">
        <span><label><input type="radio" name="pay" checked value="alipay">支付宝</label></span><span><label><input type="radio" name="pay" value="weixin">微信</label></span>
    </div>
</div>


</body>
<script src="/js/jquery.pjax.js?v=1.1.0" ></script>

<script src="/js/script.js?v=1.1.0" ></script>
<script>
    var img_resize = 'default';
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $("#post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        
        $("input[name=pay]").on("click", function () {
            if($("input[name=pay]:checked").val()=="weixin"){
                $(".shang_box .shang_payimg .pay_img").addClass("weixin_img");
            } else {
                $(".shang_box .shang_payimg .pay_img").removeClass("weixin_img");
            }
        })
        

        /*高亮代码块行号*/
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    
    function dashangToggle() {
        $(".shang_box").fadeToggle();
        $(".hide_box").fadeToggle();
    }
    

</script>

<!--加入行号的高亮代码块样式-->

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.3;
        background: url("https://i.loli.net/2019/07/22/5d3521411f3f169375.png");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
</style>







</html>
